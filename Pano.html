<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanoView Ultra | High-Res Nature</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #030712; color: #f3f4f6; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .hero-gradient { background: radial-gradient(circle at 50% -20%, #1e3a8a 0%, #030712 100%); }
        .accent-glow { box-shadow: 0 0 40px -10px rgba(59, 130, 246, 0.5); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .loader {
            width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="hero-gradient min-h-screen pb-20">

    <!-- Header Section -->
    <header class="max-w-5xl mx-auto pt-24 pb-12 px-6 text-center">
        <div class="inline-block px-4 py-1.5 mb-6 glass rounded-full text-blue-400 text-xs font-bold tracking-widest uppercase">
            Nature Panorama Engine v2.0
        </div>
        <h1 class="text-6xl md:text-8xl font-extrabold mb-6 tracking-tighter">Pano<span class="text-blue-500">View.</span></h1>
        <p class="text-gray-400 text-lg max-w-2xl mx-auto mb-10">Search and capture high-resolution 360Â° nature panoramas directly from the global archive.</p>
        
        <!-- Search Bar -->
        <div class="max-w-3xl mx-auto flex flex-col md:flex-row gap-3">
            <input type="text" id="searchInput" placeholder="Search: Alpine, Rainforest, 360 Ocean..." 
                class="w-full glass rounded-3xl py-5 px-8 text-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all accent-glow">
            <button onclick="startSearch()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-5 px-12 rounded-3xl transition-all active:scale-95">
                Search
            </button>
        </div>
    </header>

    <!-- Results Grid -->
    <main class="max-w-7xl mx-auto px-6">
        <div id="loading" class="hidden text-center py-20">
            <span class="loader mb-4"></span>
            <p class="text-gray-500">Fetching high-res files from the archive...</p>
        </div>
        
        <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Image cards will appear here -->
        </div>
    </main>

    <!-- Hidden Canvas for Image Processing -->
    <canvas id="procCanvas" style="display:none;"></canvas>

    <script>
        /**
         * SEARCH FUNCTION (Wikimedia Commons API - NO KEY REQUIRED)
         */
        async function startSearch() {
            const query = document.getElementById('searchInput').value || 'nature panorama';
            const grid = document.getElementById('resultsGrid');
            const loader = document.getElementById('loading');

            grid.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                // Search query looking specifically for high-res panoramas
                const apiURL = `https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&generator=search&gsrnamespace=6&gsrsearch=${encodeURIComponent(query + ' panorama 360 degree nature')}&gsrlimit=15&prop=imageinfo&iiprop=url|dimensions|thumburl&iiurlwidth=800`;
                
                const response = await fetch(apiURL);
                const data = await response.json();

                if (!data.query) {
                    grid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-20">No panoramas found. Try searching "Mountain 360" or "Forest panorama".</p>`;
                    return;
                }

                Object.values(data.query.pages).forEach(page => {
                    if (page.imageinfo) createCard(page.imageinfo[0], page.title);
                });

            } catch (err) {
                console.error(err);
                grid.innerHTML = `<p class="col-span-full text-center text-red-400 py-20">Database is busy. Please try clicking search again.</p>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        /**
         * CARD COMPONENT
         */
        function createCard(info, title) {
            const grid = document.getElementById('resultsGrid');
            const fileName = title.replace('File:', '').replace(/\.[^/.]+$/, "");
            
            const card = document.createElement('div');
            card.className = 'glass rounded-[2rem] overflow-hidden flex flex-col group fade-in';
            card.innerHTML = `
                <div class="h-64 overflow-hidden relative">
                    <img src="${info.thumburl}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                    <div class="absolute top-4 left-4 bg-black/60 backdrop-blur-md px-3 py-1 rounded-full text-[10px] font-bold">
                        ${info.width} x ${info.height} HD
                    </div>
                </div>
                <div class="p-8">
                    <h3 class="text-sm font-semibold truncate mb-6 text-gray-300">${fileName}</h3>
                    <div class="flex flex-col gap-3">
                        <button onclick="downloadAsPNG('${info.url}', '${fileName}')" 
                            class="bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl text-xs font-bold transition-all flex items-center justify-center gap-2">
                            <span>Direct Download (PNG)</span>
                        </button>
                        <a href="${info.url}" target="_blank" download
                            class="bg-white/5 hover:bg-white/10 text-white py-4 rounded-2xl text-[10px] font-bold transition-all text-center border border-white/10">
                            Safe Link (High-Res JPG)
                        </a>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        }

        /**
         * DOWNLOAD ENGINE
         * This uses Canvas to convert to PNG in-browser. 
         * If CORS blocks it, it provides a clear alert instead of a silent error.
         */
        function downloadAsPNG(url, name) {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span>';
            btn.disabled = true;

            const img = new Image();
            img.crossOrigin = "Anonymous"; // Required for Canvas to access the data
            
            img.onload = function() {
                const canvas = document.getElementById('procCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob((blob) => {
                    const blobUrl = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = `${name}.png`;
                    link.click();
                    URL.revokeObjectURL(blobUrl);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 'image/png');
            };

            img.onerror = function() {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert("Security block: This server prevents scripts from reading the image. \n\nPlease use the 'Safe Link' button instead to save this image!");
            };

            img.src = url;
        }

        // Search on Enter Key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startSearch();
        });

        // Load Default View
        window.onload = () => { startSearch(); };
    </script>
</body>
</html>